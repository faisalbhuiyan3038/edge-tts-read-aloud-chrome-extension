(()=>{"use strict";class e{static splitIntoSentences(t){return((t=t.replace(/\s+/g," ").trim()).match(/[^.!?]+(?:[.!?]+(?:(?=[A-Z][a-z])|$|\s))/g)||[]).map(((t,n)=>{const s=t.trim();return{text:s,index:n,isHeading:e.isHeading(s)}})).filter((e=>e.text.length>0))}static isHeading(e){return/^[A-Z0-9\s.,!?-]+$/.test(e)||/^.{1,50}:$/.test(e)||/^\d+\.\s+.{1,50}$/.test(e)}static extractTextContent(t){if("string"==typeof t){if(t.trim().startsWith("<")){const n=(new DOMParser).parseFromString(t,"text/html");return e.extractTextContent(n.body)}return t.trim()}let n="";const s=document.createTreeWalker(t,NodeFilter.SHOW_TEXT,{acceptNode:function(e){const t=e.parentElement;return"SCRIPT"===t?.tagName||"STYLE"===t?.tagName?NodeFilter.FILTER_REJECT:NodeFilter.FILTER_ACCEPT}});let r;for(;r=s.nextNode();)n+=(r.textContent||"")+" ";return n.trim()}}new class{constructor(){this.title=document.querySelector(".reader-title"),this.metadata=document.querySelector(".reader-metadata"),this.content=document.querySelector(".reader-content"),this.errorMessage=document.querySelector(".error-message"),this.pauseButton=document.getElementById("pauseButton"),this.resumeButton=document.getElementById("resumeButton"),this.stopButton=document.getElementById("stopButton"),this.setupMessageListener(),this.setupControlButtons(),this.setupClickToRead()}setupClickToRead(){if(!document.querySelector("#sentence-styles")){const e=document.createElement("style");e.id="sentence-styles",e.textContent="\n        [data-sentence-index] {\n          cursor: pointer;\n          position: relative;\n          padding-left: 2px;\n          padding-right: 2px;\n          border-radius: 2px;\n        }\n        [data-sentence-index]:hover {\n          background-color: rgba(0, 0, 0, 0.05);\n        }\n        [data-sentence-index].active {\n          background-color: rgba(0, 120, 255, 0.1);\n        }\n        [data-sentence-index].active::before {\n          content: 'â–¶';\n          position: absolute;\n          left: -15px;\n          color: rgba(0, 120, 255, 0.8);\n          font-size: 10px;\n        }\n      ",document.head.appendChild(e)}this.content.addEventListener("click",(async e=>{const t=e.target.closest("[data-sentence-index]");if(t){const e=parseInt(t.getAttribute("data-sentence-index")||"-1",10);if(e>=0){console.log("=== Click To Read Debug ==="),console.log("Clicked element:",t.outerHTML),console.log("Clicked index:",e),console.log("Clicked text:",t.textContent);try{this.updateActiveSentence(e),console.log("Sending readFromIndex message:",e);const t=await chrome.runtime.sendMessage({action:"readFromIndex",index:e});if(console.log("Received response:",t),"error"===t?.status)throw new Error(t.error||"Failed to start reading");this.enableControls()}catch(e){console.error("Failed to start reading from index:",e),this.showError("Failed to start reading from selected sentence"),this.clearActiveSentence()}}}}))}updateActiveSentence(e){this.clearActiveSentence();const t=this.content.querySelector(`[data-sentence-index="${e}"]`);t&&(t.classList.add("active"),t.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"}))}clearActiveSentence(){this.content.querySelectorAll("[data-sentence-index].active").forEach((e=>{e.classList.remove("active")}))}highlightSentence(e){this.updateActiveSentence(e)}setupMessageListener(){chrome.runtime.onMessage.addListener(((e,t,n)=>{console.log("Reader received message:",e);try{switch(e.action){case"updateContent":this.updateContent(e.content,e.title,e.metadata),n({status:"success"});break;case"readingStarted":this.enableControls(),n({status:"success"});break;case"readingStopped":this.disableControls(),n({status:"success"});break;case"error":this.showError(e.error),n({status:"success"});break;default:n({status:"error",error:"Unknown action"})}}catch(e){console.error("Error handling message:",e),n({status:"error",error:e instanceof Error?e.message:"Unknown error"})}return!1}))}setupControlButtons(){this.pauseButton.addEventListener("click",(()=>{chrome.runtime.sendMessage({action:"pauseReading"}),this.pauseButton.disabled=!0,this.resumeButton.disabled=!1})),this.resumeButton.addEventListener("click",(()=>{chrome.runtime.sendMessage({action:"resumeReading"}),this.resumeButton.disabled=!0,this.pauseButton.disabled=!1})),this.stopButton.addEventListener("click",(()=>{chrome.runtime.sendMessage({action:"stopReading",closeReader:!0}),this.disableControls()}))}updateContent(t,n,s){console.log("=== Update Content Debug ==="),this.title.textContent=n||"Reader View";let r="";s&&(s.author&&(r+=`<p class="author">By ${s.author}</p>`),s.siteName&&(r+=`<p class="site-name">From ${s.siteName}</p>`),s.excerpt&&(r+=`<p class="excerpt">${s.excerpt}</p>`)),this.metadata.innerHTML=r,this.content.innerHTML=t;let o=0;const a=[],i=document.createTreeWalker(this.content,NodeFilter.SHOW_TEXT,{acceptNode:function(e){const t=e.parentElement;return"SCRIPT"===t?.tagName||"STYLE"===t?.tagName?NodeFilter.FILTER_REJECT:NodeFilter.FILTER_ACCEPT}});let c;for(;c=i.nextNode();)a.push(c);console.log("Found text nodes:",a.length),a.forEach((t=>{const n=t.textContent||"";if(!n.trim())return;const s=e.splitIntoSentences(n);if(0===s.length)return;const r=document.createDocumentFragment();s.forEach((e=>{const n=document.createElement("span");n.setAttribute("data-sentence-index",o.toString()),n.textContent=e.text+" ",r.appendChild(n),console.log(`Created span for sentence ${o}:`,{text:e.text.substring(0,50)+(e.text.length>50?"...":""),parentTag:t.parentElement?.tagName}),o++})),t.parentNode&&t.parentNode.replaceChild(r,t)})),console.log("Total sentences created:",o),this.hideError(),this.enableControls()}enableControls(){this.pauseButton.disabled=!1,this.stopButton.disabled=!1,this.resumeButton.disabled=!0}disableControls(){this.pauseButton.disabled=!0,this.resumeButton.disabled=!0,this.stopButton.disabled=!0}showError(e){this.errorMessage.textContent=e,this.errorMessage.style.display="block",setTimeout((()=>this.hideError()),5e3)}hideError(){this.errorMessage.style.display="none",this.errorMessage.textContent=""}}})();