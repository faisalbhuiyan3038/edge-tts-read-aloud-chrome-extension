(()=>{"use strict";new class{constructor(){this.readerTabId=null,this.sourceTabId=null,this.setupMessageListener(),this.setupContextMenu(),console.log("Background script initialized")}setupMessageListener(){chrome.runtime.onMessage.addListener(((e,t,s)=>{console.log("Background received message:",e);try{switch(e.action){case"setSourceTab":this.sourceTabId=e.tabId,s({status:"success"});break;case"openReader":t.tab?.id&&(this.sourceTabId=t.tab.id),this.openReaderTab(e.text,e.title,e.metadata).then((()=>s({status:"success"}))).catch((e=>s({status:"error",error:e.message})));break;case"readSelection":this.sourceTabId&&this.sendMessageToTab(this.sourceTabId,{action:"readSelection"}).then((()=>s({status:"success"}))).catch((e=>s({status:"error",error:e.message})));break;case"stopReading":this.sourceTabId&&this.sendMessageToTab(this.sourceTabId,{action:"stopReading"}).then((()=>s({status:"success"}))).catch((e=>s({status:"error",error:e.message})));break;case"pauseReading":this.sourceTabId&&this.sendMessageToTab(this.sourceTabId,{action:"pauseReading"}).then((()=>s({status:"success"}))).catch((e=>s({status:"error",error:e.message})));break;case"resumeReading":this.sourceTabId&&this.sendMessageToTab(this.sourceTabId,{action:"resumeReading"}).then((()=>s({status:"success"}))).catch((e=>s({status:"error",error:e.message})));break;case"readingStopped":this.readerTabId&&(chrome.tabs.remove(this.readerTabId).catch(console.error),this.readerTabId=null),this.sourceTabId=null,s({status:"success"});break;case"updateReaderHighlight":this.readerTabId&&this.sendMessageToTab(this.readerTabId,{action:"highlightSentence",index:e.index,text:e.text}).then((()=>s({status:"success"}))).catch((e=>s({status:"error",error:e.message})));break;case"getSettings":chrome.storage.sync.get({voice:"Microsoft Server Speech Text to Speech Voice (en-US, AvaNeural)",speed:1},(e=>{console.log("Sending settings:",e),s(e)}));break;default:return s({status:"error",error:"Unknown action"}),!1}return!0}catch(e){return console.error("Error handling message:",e),s({status:"error",error:e instanceof Error?e.message:"Unknown error"}),!1}}))}setupContextMenu(){chrome.contextMenus.create({id:"readSelection",title:"Read Selection",contexts:["selection"]}),chrome.contextMenus.onClicked.addListener(((e,t)=>{"readSelection"===e.menuItemId&&t?.id&&(console.log("Context menu: Read selection clicked"),this.sendMessageToTab(t.id,{action:"readSelection"}).catch((e=>console.error("Failed to send readSelection message:",e))))}))}async openReaderTab(e,t,s){try{if(null!==this.readerTabId)try{if(await chrome.tabs.get(this.readerTabId))return console.log("Updating existing reader tab"),await chrome.tabs.update(this.readerTabId,{active:!0}),void await this.updateReaderContent(this.readerTabId,e,t,s)}catch(e){console.log("Previous reader tab no longer exists"),this.readerTabId=null}console.log("Creating new reader tab");const a=await chrome.tabs.create({url:chrome.runtime.getURL("reader/reader.html"),active:!0});a.id&&(this.readerTabId=a.id,await new Promise(((r,o)=>{const c=(n,i)=>{n===a.id&&"complete"===i.status&&(chrome.tabs.onUpdated.removeListener(c),setTimeout((async()=>{try{await this.updateReaderContent(n,e,t,s),r()}catch(e){o(e)}}),100))};chrome.tabs.onUpdated.addListener(c)})))}catch(e){throw console.error("Failed to open reader tab:",e),e}}async updateReaderContent(e,t,s,a){try{await this.sendMessageToTab(e,{action:"updateContent",content:t,title:s,metadata:a})}catch(e){throw console.error("Failed to update reader content:",e),e}}async sendMessageToTab(e,t){try{return await chrome.tabs.sendMessage(e,t)}catch(t){throw console.error(`Failed to send message to tab ${e}:`,t),t}}async sendMessageToActiveTab(e){try{const[t]=await chrome.tabs.query({active:!0,currentWindow:!0});if(t?.id)return console.log("Sending message to active tab:",e),await this.sendMessageToTab(t.id,e);throw new Error("No active tab found")}catch(e){throw console.error("Failed to send message to active tab:",e),e}}}})();