(()=>{"use strict";class e{constructor(){const e=this.initializeElements();e?(this.voiceSelect=e.voiceSelect,this.speedSlider=e.speedSlider,this.speedValue=e.speedValue,this.startButton=e.startButton,this.stopButton=e.stopButton,this.setupEventListeners(),this.loadSavedSettings()):console.error("Failed to initialize popup elements")}initializeElements(){const e=document.getElementById("voiceSelect"),t=document.getElementById("speedSlider"),o=document.getElementById("speedValue"),s=document.getElementById("startReading"),n=document.getElementById("stopReading");return e&&t&&o&&s&&n?{voiceSelect:e,speedSlider:t,speedValue:o,startButton:s,stopButton:n}:(console.error("Required elements not found in popup"),null)}async loadSavedSettings(){try{const e=await chrome.storage.sync.get({voice:"en-US-AvaNeural",speed:1});this.voiceSelect.value=e.voice,this.speedSlider.value=e.speed.toString(),this.speedValue.textContent=`${e.speed.toFixed(2)}x`}catch(e){console.error("Failed to load settings:",e)}}setupEventListeners(){this.speedSlider.addEventListener("input",(()=>{try{const e=parseFloat(this.speedSlider.value);this.speedValue.textContent=`${e.toFixed(2)}x`,chrome.storage.sync.set({speed:e}).catch((e=>{console.error("Failed to save speed setting:",e)}))}catch(e){console.error("Error handling speed change:",e)}})),this.voiceSelect.addEventListener("change",(()=>{try{chrome.storage.sync.set({voice:this.voiceSelect.value}).catch((e=>{console.error("Failed to save voice setting:",e)}))}catch(e){console.error("Error handling voice change:",e)}})),this.startButton.addEventListener("click",(async()=>{try{const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!e?.id)throw new Error("No active tab found");console.log("Sending startReading message to tab:",e.id);const t=await chrome.tabs.sendMessage(e.id,{action:"startReading",voice:this.voiceSelect.value,speed:parseFloat(this.speedSlider.value)});if(console.log("Received response:",t),!t||"started"!==t.status)throw new Error("Failed to start reading: Invalid response")}catch(e){console.error("Failed to start reading:",e),e?.message?.includes("Could not establish connection")?this.showError("Please refresh the page and try again. The reader needs to be reinitialized."):this.showError("Failed to start reading. "+(e.message||"Unknown error occurred."))}})),this.stopButton.addEventListener("click",(async()=>{try{const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!e?.id)throw new Error("No active tab found");console.log("Sending stopReading message to tab:",e.id);const t=await chrome.tabs.sendMessage(e.id,{action:"stopReading"});if(console.log("Received response:",t),!t||"stopped"!==t.status)throw new Error("Failed to stop reading: Invalid response")}catch(e){console.error("Failed to stop reading:",e),e?.message?.includes("Could not establish connection")?this.showError("Please refresh the page and try again. The reader needs to be reinitialized."):this.showError("Failed to stop reading. "+(e.message||"Unknown error occurred."))}}))}showError(e){let t=document.getElementById("error-message");t||(t=document.createElement("div"),t.id="error-message",t.style.color="red",t.style.padding="10px",t.style.marginTop="10px",document.body.appendChild(t)),t.textContent=e,setTimeout((()=>{t&&t.parentNode&&t.parentNode.removeChild(t)}),5e3)}}document.addEventListener("DOMContentLoaded",(()=>{new e}))})();